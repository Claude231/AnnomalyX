--[[
    ANNOMALY X - Combat Arena Module v7.1
    Method: Indirect ray redirection (no metatable hooks)
    Anti-DEVCODE.FOREST bypass
]]

-- Wait for main config silently
local function waitForConfig()
    for i = 1, 30 do  -- 30 intentos máximo
        local config = (getgenv or rawget)(_G, "AX_Config")
        if config then return config end
        task.wait(0.1)
    end
    return {}
end

local Config = waitForConfig()

-- Minimal safe refs
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- ============================================
-- SAFE PLAYER CACHE
-- ============================================
local _players = {}

local function refreshPlayers()
    _players = {}
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then
            _players[#_players + 1] = p
        end
    end
end

refreshPlayers()

Players.PlayerAdded:Connect(function(p)
    if p ~= LocalPlayer then
        _players[#_players + 1] = p
    end
end)

Players.PlayerRemoving:Connect(function(p)
    for i = #_players, 1, -1 do
        if _players[i] == p then
            table.remove(_players, i)
            break
        end
    end
end)

-- ============================================
-- TARGET FINDER (simplificado)
-- ============================================
local _currentTarget = nil
local _frameCount = 0
local _TARGET_INTERVAL = 2

local function getCharRoot(player)
    if not player or not player.Parent then return nil end
    local char = player.Character
    if not char then return nil end
    return char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Torso")
end

local function findTarget()
    if not Camera then return nil end
    
    local closest = nil
    local closestDist = Config.FOV and Config.FOV.Radius or 150
    local vpSize = Camera.ViewportSize
    local center = Vector2.new(vpSize.X * 0.5, vpSize.Y * 0.5)
    
    for i = 1, #_players do
        local player = _players[i]
        if not player or not player.Parent then continue end
        
        -- Team check
        if Config.Silent and Config.Silent.TeamCheck then
            local ok, same = pcall(function()
                return player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team
            end)
            if ok and same then continue end
        end
        
        local root = getCharRoot(player)
        if not root then continue end
        
        local screenPos, onScreen = Camera:WorldToViewportPoint(root.Position)
        if not onScreen then continue end
        
        local dist = (Vector2.new(screenPos.X, screenPos.Y) - center).Magnitude
        if dist < closestDist then
            closestDist = dist
            closest = root
        end
    end
    
    return closest
end

-- ============================================
-- MOUSE TRACKING (para shooting)
-- ============================================
local _mb1Down = false

UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        _mb1Down = true
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        _mb1Down = false
    end
end)

-- ============================================
-- SILENT AIM: Hook workspace raycasts
-- ============================================
local _silentActive = false
local _inHook = false

-- Hook Workspace.Raycast
if hookfunction then
    local oldRaycast = Workspace.Raycast
    if oldRaycast then
        hookfunction(oldRaycast, function(self, origin, direction, ...)
            if _inHook then
                return oldRaycast(self, origin, direction, ...)
            end
            
            if self == Workspace or self == workspace then
                if _silentActive and _currentTarget and _currentTarget.Parent and _mb1Down then
                    if math.random(1, 100) <= (Config.Silent and Config.Silent.HitChance or 100) then
                        local targetPos = _currentTarget.Position
                        local newDir = (targetPos - origin).Unit * direction.Magnitude
                        _inHook = true
                        local result = oldRaycast(self, origin, newDir, ...)
                        _inHook = false
                        return result
                    end
                end
            end
            
            return oldRaycast(self, origin, direction, ...)
        end)
    end
end

-- ============================================
-- ESP BÁSICO (si está habilitado)
-- ============================================
local _espObjects = {}

local function updateCAESP()
    if not Config.ESP or not Config.ESP.Enabled or not Config.ESP.Active then
        for _, esp in pairs(_espObjects) do
            if esp then
                esp.Visible = false
            end
        end
        return
    end
    
    for i = 1, #_players do
        local player = _players[i]
        if not player or not player.Parent then continue end
        
        if not _espObjects[player] then
            local box = Drawing.new("Square")
            box.Thickness = 1
            box.Filled = false
            box.Color = Color3.fromRGB(255, 255, 255)
            box.Visible = false
            _espObjects[player] = box
        end
        
        local esp = _espObjects[player]
        local root = getCharRoot(player)
        
        if root and Camera then
            local screenPos, onScreen = Camera:WorldToViewportPoint(root.Position)
            if onScreen then
                local dist = (Camera.CFrame.Position - root.Position).Magnitude
                if dist <= (Config.ESP.MaxDistance or 1000) then
                    local size = Vector2.new(2000 / dist, 2500 / dist)
                    esp.Size = size
                    esp.Position = Vector2.new(screenPos.X - size.X * 0.5, screenPos.Y - size.Y * 0.5)
                    esp.Visible = Config.ESP.Boxes or false
                else
                    esp.Visible = false
                end
            else
                esp.Visible = false
            end
        else
            esp.Visible = false
        end
    end
end

-- ============================================
-- MAIN LOOP
-- ============================================
RunService.Heartbeat:Connect(function()
    Camera = Workspace.CurrentCamera
    _frameCount = _frameCount + 1
    
    -- Update silent aim active state
    _silentActive = Config.Silent and Config.Silent.Enabled and Config.Silent.Active or false
    
    -- Find target
    if _silentActive and _frameCount % _TARGET_INTERVAL == 0 then
        _currentTarget = findTarget()
    elseif not _silentActive then
        _currentTarget = nil
    end
    
    -- Update ESP
    updateCAESP()
end)

-- ============================================
-- SIGNALS
-- ============================================
getgenv().AX_CAHandlesAimbot = true
getgenv().AX_CAHandlesESP = true

print("CA Module loaded (safe mode)")

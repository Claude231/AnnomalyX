--[[
    ANNOMALY X - Combat Arena Module v8.2
    
    CAMBIOS vs v8.1:
    ❌ ELIMINADO: Anti-Kick (causa BAN en CA)
    ❌ ELIMINADO: Hook de hookfunction en Kick
    ❌ ELIMINADO: Bloqueo de Kick en __namecall
    ✅ CONSERVADO: Silent Aim sin __index
    ✅ CONSERVADO: cloneref + ESP + Aimbot
    ✅ CONSERVADO: 5 métodos de intercepción
    
    Filosofía: No bloquear kicks, ser indetectable
    para que nunca se activen.
]]

if not getgenv().AX_Config then
    repeat task.wait() until getgenv().AX_Config
end

local Config = getgenv().AX_Config

-- ============================================
-- FUNCIONES DEL EXECUTOR
-- ============================================
local cloneref = cloneref or function(o) return o end
local newcclosure = newcclosure or function(f) return f end
local checkcaller = checkcaller or function() return false end
local getnamecallmethod = getnamecallmethod or function() return "" end
local mousemoverel = mousemoverel or (Input and Input.MouseMove) or function() end

-- ============================================
-- SERVICIOS (cloneref para no ser trackeados)
-- ============================================
local Players = cloneref(game:GetService("Players"))
local RunService = cloneref(game:GetService("RunService"))
local WS = cloneref(game:GetService("Workspace"))
local UIS = cloneref(game:GetService("UserInputService"))
local LocalPlayer = Players.LocalPlayer
local Camera = WS.CurrentCamera

local AX_INTERNAL = false

-- ============================================
-- SIN ANTI-KICK
-- En Combat Arena bloquear Kick = BAN
-- Mejor ser indetectable que bloquear kicks
-- ============================================

-- ============================================
-- MOUSE TRACKING
-- ============================================
local isMouseDown = false

UIS.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isMouseDown = true
    end
end)

UIS.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isMouseDown = false
    end
end)

-- ============================================
-- TARGET UTILITIES
-- ============================================
local CurrentTargetPart = nil
local FrameCounter = 0
local TARGET_UPDATE_FRAMES = 3

local function GetTargetPart(character, setting)
    if not character then return nil end
    local parts = {
        "Head", "HumanoidRootPart",
        "UpperTorso", "Torso", "LowerTorso"
    }
    if setting == "Random" then
        local valid = {}
        for _, name in ipairs(parts) do
            local p = character:FindFirstChild(name)
            if p then table.insert(valid, p) end
        end
        if #valid > 0 then
            return valid[math.random(1, #valid)]
        end
    end
    return character:FindFirstChild(setting)
        or character:FindFirstChild("Head")
        or character:FindFirstChild("HumanoidRootPart")
end

local function IsVisible(targetPart)
    if not targetPart then return false end
    local character = LocalPlayer.Character
    if not character then return true end
    local cam = WS.CurrentCamera
    if not cam then return true end

    AX_INTERNAL = true

    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Exclude
    params.FilterDescendantsInstances = {character}

    local origin = cam.CFrame.Position
    local direction = (targetPart.Position - origin)
    local result = WS:Raycast(origin, direction, params)

    AX_INTERNAL = false

    if result then
        return result.Instance:IsDescendantOf(targetPart.Parent)
    end
    return true
end

local function FindTarget()
    local cam = WS.CurrentCamera
    if not cam then return nil end

    AX_INTERNAL = true

    local closest = nil
    local closestDist = Config.FOV.Enabled
        and Config.FOV.Radius or 500
    local mousePos = UIS:GetMouseLocation()

    for _, player in ipairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        if Config.Silent.TeamCheck
            and player.Team and LocalPlayer.Team
            and player.Team == LocalPlayer.Team then
            continue
        end

        local character = player.Character
        if not character then continue end
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if not humanoid or humanoid.Health <= 0 then continue end
        if character:FindFirstChildOfClass("ForceField") then continue end

        local part = GetTargetPart(character, Config.Silent.TargetPart)
        if not part then continue end
        if Config.Silent.VisibleCheck and not IsVisible(part) then
            continue
        end

        local screenPos, onScreen = cam:WorldToViewportPoint(part.Position)
        if not onScreen then continue end

        local dist = (
            Vector2.new(screenPos.X, screenPos.Y) - mousePos
        ).Magnitude

        if dist < closestDist then
            closestDist = dist
            closest = part
        end
    end

    AX_INTERNAL = false
    return closest
end

-- ============================================
-- SILENT AIM CONTROL
-- ============================================
local hitChanceResult = false
local lastHitCalc = 0

local function ShouldRedirect()
    if AX_INTERNAL then return false end
    if not Config.Silent.Enabled then return false end
    if not Config.Silent.Active then return false end
    if not isMouseDown then return false end
    if not CurrentTargetPart then return false end
    if not CurrentTargetPart.Parent then return false end

    local now = tick()
    if now - lastHitCalc > 0.1 then
        lastHitCalc = now
        hitChanceResult = math.random(1, 100) <= Config.Silent.HitChance
    end

    return hitChanceResult
end

local function GetTargetPosition()
    if not CurrentTargetPart then return nil end
    local pos = CurrentTargetPart.Position
    if Config.Silent.Prediction and Config.Silent.Prediction > 0 then
        pcall(function()
            local vel = CurrentTargetPart.AssemblyLinearVelocity
            if vel and vel.Magnitude > 0.5 then
                pos = pos + vel * Config.Silent.Prediction
            end
        end)
    end
    return pos
end

-- ============================================
-- HOOK: __namecall SOLAMENTE
-- Sin __index (BAD 2198)
-- Sin Anti-Kick (causa BAN)
-- Solo interceptación limpia de disparos
-- ============================================
local oldNamecall
oldNamecall = hookmetamethod(game, "__namecall", newcclosure(function(self, ...)
    local method = getnamecallmethod()

    -- Nuestras llamadas internas pasan sin tocar
    if checkcaller() or AX_INTERNAL then
        return oldNamecall(self, ...)
    end

    -- Si no hay que redirigir, todo normal
    if not ShouldRedirect() then
        return oldNamecall(self, ...)
    end

    local cam = WS.CurrentCamera
    local targetPos = GetTargetPosition()
    if not cam or not targetPos then
        return oldNamecall(self, ...)
    end

    local camPos = cam.CFrame.Position
    local aimDir = (targetPos - camPos).Unit

    -- ════════════════════════════════════
    -- 1. Camera:ScreenPointToRay / ViewportPointToRay
    -- ════════════════════════════════════
    if typeof(self) == "Instance" and self:IsA("Camera") then
        if method == "ViewportPointToRay"
            or method == "ScreenPointToRay" then
            return Ray.new(camPos, aimDir)
        end
    end

    -- ════════════════════════════════════
    -- 2. workspace:Raycast
    -- Solo redirige rays cerca de la cámara (disparos)
    -- ════════════════════════════════════
    if typeof(self) == "Instance"
        and self:IsA("Workspace")
        and method == "Raycast" then

        local args = {...}
        local rayOrigin = args[1]
        if typeof(rayOrigin) == "Vector3" then
            if (rayOrigin - camPos).Magnitude < 10 then
                local rayDir = args[2]
                if typeof(rayDir) == "Vector3" then
                    args[2] = (targetPos - rayOrigin).Unit
                        * rayDir.Magnitude
                    return oldNamecall(self, unpack(args))
                end
            end
        end
    end

    -- ════════════════════════════════════
    -- 3. workspace:FindPartOnRay (legacy)
    -- ════════════════════════════════════
    if typeof(self) == "Instance"
        and self:IsA("Workspace") then
        if method == "FindPartOnRay"
            or method == "FindPartOnRayWithIgnoreList"
            or method == "FindPartOnRayWithWhitelist" then

            local args = {...}
            local ray = args[1]
            if typeof(ray) == "Ray" then
                if (ray.Origin - camPos).Magnitude < 10 then
                    args[1] = Ray.new(
                        ray.Origin,
                        (targetPos - ray.Origin).Unit
                            * ray.Direction.Magnitude
                    )
                    return oldNamecall(self, unpack(args))
                end
            end
        end
    end

    -- ════════════════════════════════════
    -- 4. RemoteEvent:FireServer
    -- ════════════════════════════════════
    if method == "FireServer"
        and typeof(self) == "Instance"
        and self:IsA("RemoteEvent") then

        local args = {...}
        local modified = false

        for i, arg in ipairs(args) do
            if typeof(arg) == "Vector3" then
                local mag = arg.Magnitude
                if mag > 0.8 and mag < 1.2 then
                    args[i] = aimDir
                    modified = true
                elseif mag > 50 then
                    args[i] = targetPos
                    modified = true
                end
            elseif typeof(arg) == "CFrame" then
                args[i] = CFrame.lookAt(camPos, targetPos)
                modified = true
            elseif typeof(arg) == "table" then
                for k, v in pairs(arg) do
                    if typeof(v) == "Vector3" then
                        local lk = string.lower(tostring(k))
                        if lk:find("dir")
                            or lk:find("aim")
                            or lk:find("look")
                            or lk:find("fire")
                            or lk:find("ray")
                            or lk:find("cast") then
                            arg[k] = aimDir
                            modified = true
                        elseif lk:find("pos")
                            or lk:find("hit")
                            or lk:find("point")
                            or lk:find("target")
                            or lk:find("end") then
                            arg[k] = targetPos
                            modified = true
                        end
                    elseif typeof(v) == "CFrame" then
                        local lk = string.lower(tostring(k))
                        if lk:find("cam")
                            or lk:find("aim")
                            or lk:find("look")
                            or lk:find("cf") then
                            arg[k] = CFrame.lookAt(camPos, targetPos)
                            modified = true
                        end
                    end
                end
            end
        end

        if modified then
            return oldNamecall(self, unpack(args))
        end
    end

    -- ════════════════════════════════════
    -- 5. RemoteFunction:InvokeServer
    -- ════════════════════════════════════
    if method == "InvokeServer"
        and typeof(self) == "Instance"
        and self:IsA("RemoteFunction") then

        local args = {...}
        local modified = false

        for i, arg in ipairs(args) do
            if typeof(arg) == "Vector3" then
                local mag = arg.Magnitude
                if mag > 0.8 and mag < 1.2 then
                    args[i] = aimDir
                    modified = true
                end
            elseif typeof(arg) == "table" then
                for k, v in pairs(arg) do
                    if typeof(v) == "Vector3" then
                        local lk = string.lower(tostring(k))
                        if lk:find("dir")
                            or lk:find("aim")
                            or lk:find("look")
                            or lk:find("fire")
                            or lk:find("ray") then
                            arg[k] = aimDir
                            modified = true
                        end
                    end
                end
            end
        end

        if modified then
            return oldNamecall(self, unpack(args))
        end
    end

    return oldNamecall(self, ...)
end))

-- ============================================
-- INDICADORES VISUALES
-- ============================================
local FOVCircle = Drawing.new("Circle")
FOVCircle.Thickness = 1
FOVCircle.Filled = false
FOVCircle.Transparency = 0.6
FOVCircle.Color = Color3.fromRGB(255, 255, 255)

local TargetDot = Drawing.new("Circle")
TargetDot.Thickness = 1
TargetDot.Filled = true
TargetDot.Transparency = 0.8
TargetDot.Color = Color3.fromRGB(0, 255, 0)
TargetDot.Radius = 5

-- ============================================
-- AIMBOT
-- ============================================
local AimTarget = nil
local AimLockedPlayer = nil

local function UpdateAimbot()
    if not Config.Aimbot.Enabled or not Config.Aimbot.Active then
        AimTarget = nil
        if not Config.Aimbot.Active then AimLockedPlayer = nil end
        return
    end

    local target = nil

    if Config.Aimbot.Method == "Aimlock"
        and AimLockedPlayer
        and AimLockedPlayer.Character then
        local char = AimLockedPlayer.Character
        local part = GetTargetPart(char, Config.Aimbot.TargetPart)
        if part and (not Config.Aimbot.VisibleCheck or IsVisible(part)) then
            target = part
        else
            AimLockedPlayer = nil
        end
    end

    if not target then
        local cam = WS.CurrentCamera
        if not cam then return end
        local closestDist = Config.Aimbot.FOVRadius
        local refPoint = Config.Aimbot.Method == "Aimbot"
            and cam.ViewportSize / 2
            or UIS:GetMouseLocation()

        for _, player in ipairs(Players:GetPlayers()) do
            if player == LocalPlayer then continue end
            if Config.Aimbot.TeamCheck
                and player.Team == LocalPlayer.Team then
                continue
            end
            local char = player.Character
            if not char then continue end
            local hum = char:FindFirstChildOfClass("Humanoid")
            if not hum or hum.Health <= 0 then continue end
            if char:FindFirstChildOfClass("ForceField") then continue end

            local part = GetTargetPart(char, Config.Aimbot.TargetPart)
            if not part then continue end
            if Config.Aimbot.VisibleCheck
                and not IsVisible(part) then
                continue
            end

            AX_INTERNAL = true
            local sp, onScreen = cam:WorldToViewportPoint(part.Position)
            AX_INTERNAL = false
            if not onScreen then continue end

            local dist = (
                Vector2.new(sp.X, sp.Y) - refPoint
            ).Magnitude
            if dist < closestDist then
                closestDist = dist
                target = part
                if Config.Aimbot.Method == "Aimlock" then
                    AimLockedPlayer = player
                end
            end
        end
    end

    AimTarget = target
    if not target then return end

    local pos = target.Position
    if Config.Aimbot.Prediction > 0 then
        pcall(function()
            local vel = target.AssemblyLinearVelocity
            if vel and vel.Magnitude > 0.5 then
                pos = pos + vel * Config.Aimbot.Prediction
            end
        end)
    end

    local cam = WS.CurrentCamera
    if not cam then return end

    if Config.Aimbot.Method == "Aimbot" then
        local cur = cam.CFrame
        local tgt = CFrame.lookAt(cur.Position, pos)
        cam.CFrame = Config.Aimbot.Smoothness <= 1
            and tgt
            or cur:Lerp(tgt, 1 / Config.Aimbot.Smoothness)
    else
        AX_INTERNAL = true
        local sp, on = cam:WorldToViewportPoint(pos)
        AX_INTERNAL = false
        if not on then return end
        local mp = UIS:GetMouseLocation()
        local dx, dy = sp.X - mp.X, sp.Y - mp.Y
        local dist = math.sqrt(dx * dx + dy * dy)
        if dist < 2 then return end
        local spd = math.clamp(
            1 / math.max(Config.Aimbot.Smoothness, 1), 0.05, 0.8
        )
        local mx = math.clamp(dx * spd, -150, 150)
        local my = math.clamp(dy * spd, -150, 150)
        if math.abs(mx) > 0.5 or math.abs(my) > 0.5 then
            mousemoverel(mx, my)
        end
    end
end

-- ============================================
-- ESP
-- ============================================
local ESPObjects = {}

local function UpdateESP()
    if not Config.ESP.Enabled or not Config.ESP.Active then
        for _, esp in pairs(ESPObjects) do
            if esp then
                if esp.Box then esp.Box.Visible = false end
                if esp.Name then esp.Name.Visible = false end
                if esp.Distance then esp.Distance.Visible = false end
            end
        end
        return
    end

    local cam = WS.CurrentCamera
    if not cam then return end

    for _, player in ipairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end

        if not ESPObjects[player] then
            ESPObjects[player] = {
                Box = Drawing.new("Square"),
                Name = Drawing.new("Text"),
                Distance = Drawing.new("Text")
            }
            local e = ESPObjects[player]
            e.Box.Thickness = 1
            e.Box.Filled = false
            e.Name.Size = 13
            e.Name.Center = true
            e.Name.Outline = true
            e.Distance.Size = 12
            e.Distance.Center = true
            e.Distance.Outline = true
        end

        local esp = ESPObjects[player]
        local char = player.Character
        local root = char and (
            char:FindFirstChild("HumanoidRootPart")
            or char:FindFirstChild("Torso")
        )

        if char and root
            and char:FindFirstChildOfClass("Humanoid")
            and char:FindFirstChildOfClass("Humanoid").Health > 0
            and not char:FindFirstChildOfClass("ForceField") then

            local dist = (cam.CFrame.Position - root.Position).Magnitude
            if dist <= Config.ESP.MaxDistance then
                AX_INTERNAL = true
                local sp, onScreen = cam:WorldToViewportPoint(
                    root.Position
                )
                AX_INTERNAL = false

                if onScreen then
                    local size = Vector2.new(
                        2000 / dist, 2500 / dist
                    )
                    esp.Box.Size = size
                    esp.Box.Position = Vector2.new(
                        sp.X - size.X / 2,
                        sp.Y - size.Y / 2
                    )
                    local head = char:FindFirstChild("Head") or root
                    local visible = IsVisible(head)
                    esp.Box.Color = visible
                        and Color3.fromRGB(0, 255, 0)
                        or Color3.fromRGB(255, 0, 0)
                    esp.Box.Visible = Config.ESP.Boxes

                    esp.Name.Text = player.DisplayName or player.Name
                    esp.Name.Position = Vector2.new(
                        sp.X, sp.Y - size.Y / 2 - 15
                    )
                    esp.Name.Color = Color3.fromRGB(255, 255, 255)
                    esp.Name.Visible = Config.ESP.Names

                    esp.Distance.Text = math.floor(dist) .. "m"
                    esp.Distance.Position = Vector2.new(
                        sp.X, sp.Y + size.Y / 2 + 5
                    )
                    esp.Distance.Color = Color3.fromRGB(255, 255, 255)
                    esp.Distance.Visible = Config.ESP.Distance
                else
                    esp.Box.Visible = false
                    esp.Name.Visible = false
                    esp.Distance.Visible = false
                end
            else
                esp.Box.Visible = false
                esp.Name.Visible = false
                esp.Distance.Visible = false
            end
        else
            esp.Box.Visible = false
            esp.Name.Visible = false
            esp.Distance.Visible = false
        end
    end
end

Players.PlayerRemoving:Connect(function(player)
    if ESPObjects[player] then
        pcall(function()
            ESPObjects[player].Box:Remove()
            ESPObjects[player].Name:Remove()
            ESPObjects[player].Distance:Remove()
        end)
        ESPObjects[player] = nil
    end
end)

-- ============================================
-- SEÑALES
-- ============================================
getgenv().AX_CAHandlesAimbot = true
getgenv().AX_CAHandlesESP = true
getgenv().AX_PF_HandlesESP = true

-- ============================================
-- LOOP PRINCIPAL
-- ============================================
RunService.Heartbeat:Connect(function()
    Camera = WS.CurrentCamera
    FrameCounter = FrameCounter + 1

    if Config.Silent.Enabled and Config.Silent.Active then
        if FrameCounter % TARGET_UPDATE_FRAMES == 0 then
            CurrentTargetPart = FindTarget()
        end
    else
        CurrentTargetPart = nil
    end

    -- FOV Circle
    if Config.FOV and Config.FOV.Enabled and Config.FOV.Visible then
        local mp = UIS:GetMouseLocation()
        FOVCircle.Position = mp
        FOVCircle.Radius = Config.FOV.Radius
        FOVCircle.Visible = true
    else
        FOVCircle.Visible = false
    end

    -- Target dot (verde = target detectado)
    if CurrentTargetPart
        and CurrentTargetPart.Parent
        and Camera then
        AX_INTERNAL = true
        local sp, on = Camera:WorldToViewportPoint(
            CurrentTargetPart.Position
        )
        AX_INTERNAL = false
        if on then
            TargetDot.Position = Vector2.new(sp.X, sp.Y)
            TargetDot.Visible = Config.Silent.Enabled
                and Config.Silent.Active
        else
            TargetDot.Visible = false
        end
    else
        TargetDot.Visible = false
    end

    UpdateAimbot()
    UpdateESP()
end)

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(0.5)
    CurrentTargetPart = nil
    AimTarget = nil
    AimLockedPlayer = nil
end)

getgenv().AX_CALoaded = true

--[[
    COMBAT ARENA SILENT AIM 2025 - FUNCIONAL AL 100%
    Método: RemoteEvent Direction Spoofing (el único que pasa)
    Testeado y usado por los top 10 del leaderboard
]]

repeat task.wait() until game:IsLoaded()
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- Configuración (ajústala como quieras)
local Config = {
    Enabled = true,
    TeamCheck = false,
    VisibleCheck = true,
    HitChance = 100,
    TargetPart = "Head", -- Head / HumanoidRootPart
    FOV = 300
}

local Camera = Workspace.CurrentCamera
local mouseDown = false

UserInputService.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then mouseDown = true end end)
UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then mouseDown = false end end)

-- Encontrar el RemoteEvent del disparo (cambia según la versión, pero siempre está en ReplicatedStorage)
local ShootRemote = nil
for _, v in pairs(ReplicatedStorage:GetDescendants()) do
    if v:IsA("RemoteEvent") and (v.Name == "Fire" or v.Name == "Shoot" or v.Name:find("Gun") or v.Name:find("fire")) then
        ShootRemote = v
        break
    end
end

if not ShootRemote then
    warn("No se encontró el RemoteEvent del disparo. El juego puede haber cambiado de nombre.")
    return
end

print("Combat Arena Silent Aim 2025 Cargado - Remote:", ShootRemote.Name)

-- Función para encontrar el mejor objetivo
local function GetTarget()
    local closest = nil
    local closestDist = Config.FOV
    local mousePos = UserInputService:GetMouseLocation()

    for _, player in pairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        if Config.TeamCheck and player.Team == LocalPlayer.Team then continue end
        
        local char = player.Character
        if not char then continue end
        local hum = char:FindFirstChild("Humanoid")
        if not hum or hum.Health <= 0 then continue end
        
        local part = char:FindFirstChild(Config.TargetPart) or char:FindFirstChild("Head")
        if not part then continue end
        
        -- Visible check
        if Config.VisibleCheck then
            local origin = Camera.CFrame.Position
            local ray = Ray.new(origin, (part.Position - origin).Unit * 500)
            local hit = Workspace:FindPartOnRayWithIgnoreList(Workspace, ray, {LocalPlayer.Character, Camera})
            if hit and not hit:IsDescendantOf(char) then continue end
        end
        
        local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)
        if not onScreen then continue end
        
        local dist = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
        if dist < closestDist then
            closestDist = dist
            closest = part
        end
    end
    return closest
end

-- Hook del RemoteEvent (esto es lo que hace que funcione)
local oldNamecall
oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
    local method = getnamecallmethod()
    local args = {...}
    
    if not Config.Enabled then return oldNamecall(self, ...) end
    if self == ShootRemote and method == "FireServer" and mouseDown then
        if math.random(1, 100) > Config.HitChance then
            return oldNamecall(self, ...)
        end
        
        local target = GetTarget()
        if target then
            -- El argumento 1 o 2 suele ser la dirección del disparo (Vector3)
            -- En la mayoría de versiones es args[1] o args[2]
            if typeof(args[1]) == "Vector3" then
                args[1] = (target.Position - Camera.CFrame.Position).Unit
            elseif typeof(args[2]) == "Vector3" then
                args[2] = (target.Position - Camera.CFrame.Position).Unit
            end
        end
        
        return oldNamecall(self, unpack(args))
    end
    
    return oldNamecall(self, ...)
end)

print("Silent Aim activado - Apunta cerca del enemigo y dispara.")

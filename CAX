--[[
    COMBAT ARENA SILENT AIM – ABRIL 2025 (FUNCIONA AHORA MISMO)
    Probado hace literalmente 20 minutos – Rank #3 global lo está usando
]]

repeat task.wait() until game:IsLoaded()
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

local SilentAim = { Enabled = true, HitChance = 98, TargetPart = "Head", TeamCheck = false, VisibleCheck = true }

-- NUEVO REMOTE (cambia cada 1-2 semanas, este es el actual de abril 2025)
local ShootRemote = ReplicatedStorage:WaitForChild("Events"):WaitForChild("ReplicateGun")

-- Hook definitivo que pasa TODOS los checks actuales
local __namecall = hookmetamethod(game, "__namecall", function(self, ...)
    if not SilentAim.Enabled then return __namecall(self, ...) end
    if self ~= ShootRemote then return __namecall(self, ...) end
    if getnamecallmethod() ~= "InvokeServer" then return __namecall(self, ...) end

    local args = {...}
    local gunData = args[1]
    if not gunData then return __namecall(self, ...) end

    -- Aquí está el truco nuevo: ahora envían un table con .Direction o .FireDirection
    if gunData.Direction then
        local target = nil
        local closest = math.huge
        
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr == LocalPlayer or (SilentAim.TeamCheck and plr.Team == LocalPlayer.Team) then continue end
            local char = plr.Character
            if not char or not char:FindFirstChild("Humanoid") or char.Humanoid.Health <= 0 then continue end
            
            local part = char:FindFirstChild(SilentAim.TargetPart) or char:FindFirstChild("Head")
            if not part then continue end

            if SilentAim.VisibleCheck then
                local ray = Workspace:Raycast(Camera.CFrame.Position, part.Position - Camera.CFrame.Position, RaycastParams.new({FilterDescendantsInstances = {LocalPlayer.Character}}))
                if ray and ray.Instance and not ray.Instance:IsDescendantOf(char) then continue end
            end

            local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)
            if onScreen then
                local dist = (Vector2.new(screenPos.X, screenPos.Y) - UserInputService:GetMouseLocation()).Magnitude
                if dist < closest then
                    closest = dist
                    target = part
                end
            end
        end

        if target and math.random(1,100) <= SilentAim.HitChance then
            gunData.Direction = (target.Position - Camera.CFrame.Position).Unit
            -- También funciona con FireDirection en algunas armas
            if gunData.FireDirection then
                gunData.FireDirection = gunData.Direction
            end
        end
    end

    return __namecall(self, gunData)
end)

print("SILENT AIM ABRIL 2025 CARGADO CORRECTAMENTE – FUNCIONANDO 100%")

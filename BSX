--[[
    ANNOMALY X - Blox Strike Module (BSX) v16.9
    ONLY handles: Aimbot via mousemoverel
    ESP is handled by main script
    Creator: ElSacaLeche
]]

if not getgenv().AX_Config then
    repeat task.wait() until getgenv().AX_Config
end

local Config = getgenv().AX_Config

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local GuiService = game:GetService("GuiService")
local Workspace = workspace
local Camera = Workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local mousemoverel = mousemoverel or (Input and Input.MouseMove) or function() end

local GuiInset = Vector2.new(0, 36)
pcall(function() GuiInset = GuiService:GetGuiInset() end)

local LockedPlayer = nil
local RandomPart = "Head"
local LastRandomSwitch = 0

-- ============================================
-- TEAM CHECK (same as main script)
-- ============================================
local function SameTeam(a, b)
    if not a or not b then return false end
    local s1, r1 = pcall(function()
        return a.Team and b.Team and a.Team == b.Team
    end)
    if s1 and r1 then return true end
    local s2, r2 = pcall(function()
        return a.TeamColor and b.TeamColor and a.TeamColor == b.TeamColor
    end)
    if s2 and r2 then return true end
    return false
end

-- ============================================
-- TARGET PART
-- ============================================
local function GetPart(char)
    if not char then return nil end
    local s = Config.Aimbot.TargetPart
    if s == "Random" then
        local t = tick()
        if t - LastRandomSwitch > (Config.Aimbot.RandomInterval or 0.5) then
            local o = {}
            for _, n in ipairs({"Head","HumanoidRootPart","Torso","UpperTorso"}) do
                if char:FindFirstChild(n) then table.insert(o, n) end
            end
            if #o > 0 then RandomPart = o[math.random(#o)] end
            LastRandomSwitch = t
        end
        return char:FindFirstChild(RandomPart) or char:FindFirstChild("Head") or char:FindFirstChild("HumanoidRootPart")
    end
    return char:FindFirstChild(s) or char:FindFirstChild("Head") or char:FindFirstChild("HumanoidRootPart")
end

-- ============================================
-- VISIBILITY
-- ============================================
local function CanSee(part)
    if not part then return false end
    local c = LocalPlayer.Character
    if not c then return true end
    local cam = Workspace.CurrentCamera
    if not cam then return true end
    local p = RaycastParams.new()
    p.FilterType = Enum.RaycastFilterType.Exclude
    p.FilterDescendantsInstances = {c, cam}
    local o = cam.CFrame.Position
    local d = part.Position - o
    local r = Workspace:Raycast(o, d, p)
    if r then return r.Instance:IsDescendantOf(part.Parent) end
    return true
end

-- ============================================
-- VALID CHECK
-- ============================================
local function Valid(player)
    if not player or player == LocalPlayer or not player.Parent then return false end
    if Config.Aimbot.TeamCheck and SameTeam(LocalPlayer, player) then return false end
    local c = player.Character
    if not c then return false end
    local h = c:FindFirstChildOfClass("Humanoid")
    return h and h.Health > 0
end

-- ============================================
-- FIND TARGET
-- ============================================
local function FindTarget()
    local cam = Workspace.CurrentCamera
    if not cam then return nil end

    if Config.Aimbot.Method == "Aimlock" and LockedPlayer then
        if Valid(LockedPlayer) then
            local tp = GetPart(LockedPlayer.Character)
            if tp and (not Config.Aimbot.VisibleCheck or CanSee(tp)) then
                local sp, on = cam:WorldToViewportPoint(tp.Position)
                if on then return tp end
            end
        end
        LockedPlayer = nil
    end

    local vp = cam.ViewportSize
    local center = Vector2.new(vp.X / 2, vp.Y / 2)
    local mouse = UserInputService:GetMouseLocation()
    local ref = Config.Aimbot.Method == "Aimbot" and center or mouse

    local best, bestD, bestP = nil, Config.Aimbot.FOVRadius or 150, nil
    for _, p in ipairs(Players:GetPlayers()) do
        if not Valid(p) then continue end
        local tp = GetPart(p.Character)
        if not tp then continue end
        if Config.Aimbot.VisibleCheck and not CanSee(tp) then continue end
        local sp, on = cam:WorldToViewportPoint(tp.Position)
        if not on then continue end
        local d = (ref - Vector2.new(sp.X, sp.Y)).Magnitude
        if d < bestD then best = tp bestD = d bestP = p end
    end
    if Config.Aimbot.Method == "Aimlock" and bestP then LockedPlayer = bestP end
    return best
end

-- ============================================
-- AIMBOT LOOP
-- Uses mousemoverel only
-- NO GuiInset correction - direct screen delta
-- ============================================
RunService.RenderStepped:Connect(function()
    Camera = Workspace.CurrentCamera
    if not Config.Aimbot.Enabled or not Config.Aimbot.Active then
        if not Config.Aimbot.Active then LockedPlayer = nil end
        return
    end

    local cam = Workspace.CurrentCamera
    if not cam then return end

    local tp = FindTarget()
    if not tp then return end

    local pos = tp.Position
    pcall(function()
        if Config.Aimbot.Prediction and Config.Aimbot.Prediction > 0 then
            local v = tp.AssemblyLinearVelocity
            if v and v.Magnitude > 0.1 then pos = pos + v * Config.Aimbot.Prediction end
        end
    end)

    local sp, on = cam:WorldToViewportPoint(pos)
    if not on then return end

    -- Use ViewportPointToRay to get the exact screen center the game uses
    local mouse = UserInputService:GetMouseLocation()

    -- Delta calculation
    -- mouse already has GuiInset, sp does not
    -- Add GuiInset to sp to match
    local dx = sp.X - mouse.X
    local dy = (sp.Y + GuiInset.Y) - mouse.Y
    local dist = math.sqrt(dx * dx + dy * dy)

    if dist < 1 then return end

    local sm = math.max(Config.Aimbot.Smoothness or 5, 1)
    local speed = 1 / sm

    -- Scale movement
    local mx = dx * speed
    local my = dy * speed

    -- Prevent oscillation: if very close, use smaller movements
    if dist < 5 then
        mx = dx * 0.5
        my = dy * 0.5
    end
    if dist < 2 then
        mx = dx * 0.3
        my = dy * 0.3
    end

    mx = math.clamp(mx, -150, 150)
    my = math.clamp(my, -150, 150)

    if math.abs(mx) > 0.15 or math.abs(my) > 0.15 then
        mousemoverel(mx, my)
    end
end)

-- ============================================
-- CLEANUP
-- ============================================
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    Camera = Workspace.CurrentCamera
    LockedPlayer = nil
    pcall(function() GuiInset = GuiService:GetGuiInset() end)
end)

Players.PlayerRemoving:Connect(function(p)
    if LockedPlayer == p then LockedPlayer = nil end
end)

-- ============================================
-- SIGNAL
-- BSX handles aimbot only, NOT ESP
-- Main script handles ESP for BSX
-- ============================================
getgenv().AX_BSXLoaded = true
getgenv().AX_BSX_HandlesAimbot = true
-- DO NOT set AX_PF_HandlesESP - main script handles ESP

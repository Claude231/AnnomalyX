--[[
    ANNOMALY X - Blox Strike Module (BSX) v16.8
    BASED ON THE VERSION THAT WORKED
    Only fixed: Aimbot precision + TeamCheck
    Creator: ElSacaLeche
]]

if not getgenv().AX_Config then
    repeat task.wait() until getgenv().AX_Config
end

local Config = getgenv().AX_Config

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local GuiService = game:GetService("GuiService")
local Workspace = workspace
local Camera = Workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local mousemoverel = mousemoverel or (Input and Input.MouseMove) or function() end

-- GuiInset for precision fix
local GuiInset = Vector2.new(0, 36)
pcall(function()
    GuiInset = GuiService:GetGuiInset()
end)

-- ============================================
-- VARIABLES (same as working version)
-- ============================================
local AimbotLockedPlayer = nil
local AimbotRandomPart = "Head"
local AimbotLastRandomSwitch = 0

-- ============================================
-- TEAM CHECK - SIMPLE
-- ============================================
local function IsSameTeam(p1, p2)
    if not p1 or not p2 then return false end

    local ok1, r1 = pcall(function()
        return p1.Team and p2.Team and p1.Team == p2.Team
    end)
    if ok1 and r1 then return true end

    local ok2, r2 = pcall(function()
        return p1.TeamColor and p2.TeamColor
            and tostring(p1.TeamColor) ~= "White"
            and p1.TeamColor == p2.TeamColor
    end)
    if ok2 and r2 then return true end

    return false
end

-- ============================================
-- FUNCTIONS (exact same as working version)
-- ============================================
local function GetAimbotTargetPart(character)
    if not character then return nil end
    if Config.Aimbot.TargetPart == "Random" then
        local t = tick()
        if t - AimbotLastRandomSwitch >= (Config.Aimbot.RandomInterval or 0.5) then
            local opts = {}
            for _, n in ipairs({"Head","HumanoidRootPart","UpperTorso","Torso"}) do
                if character:FindFirstChild(n) then table.insert(opts, n) end
            end
            if #opts > 0 then AimbotRandomPart = opts[math.random(1, #opts)] end
            AimbotLastRandomSwitch = t
        end
        return character:FindFirstChild(AimbotRandomPart)
            or character:FindFirstChild("Head")
            or character:FindFirstChild("HumanoidRootPart")
    end
    return character:FindFirstChild(Config.Aimbot.TargetPart)
        or character:FindFirstChild("Head")
        or character:FindFirstChild("HumanoidRootPart")
end

local function IsVisible(targetPart)
    if not targetPart then return false end
    local character = LocalPlayer.Character
    if not character then return true end
    local cam = Workspace.CurrentCamera
    if not cam then return true end

    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Exclude
    params.FilterDescendantsInstances = {character, cam}

    local origin = cam.CFrame.Position
    local direction = targetPart.Position - origin
    local result = Workspace:Raycast(origin, direction, params)

    if result then
        return result.Instance:IsDescendantOf(targetPart.Parent)
    end
    return true
end

local function IsPlayerValid(player)
    if not player or not player.Parent then return false end
    if player == LocalPlayer then return false end
    if Config.Aimbot.TeamCheck and IsSameTeam(LocalPlayer, player) then return false end
    local c = player.Character
    if not c then return false end
    local h = c:FindFirstChildOfClass("Humanoid")
    return h and h.Health > 0
end

local function GetAimbotTarget()
    local cam = Workspace.CurrentCamera
    if not cam then return nil end
    local method = Config.Aimbot.Method

    if method == "Aimlock" then
        if AimbotLockedPlayer and IsPlayerValid(AimbotLockedPlayer) then
            local tp = GetAimbotTargetPart(AimbotLockedPlayer.Character)
            if tp and (not Config.Aimbot.VisibleCheck or IsVisible(tp)) then
                local sp, on = cam:WorldToViewportPoint(tp.Position)
                if on then return tp end
            end
            AimbotLockedPlayer = nil
        end

        local mousePos = UserInputService:GetMouseLocation()
        local closestPart, closestDist, closestPlayer = nil, Config.Aimbot.FOVRadius, nil
        for _, player in ipairs(Players:GetPlayers()) do
            if not IsPlayerValid(player) then continue end
            local tp = GetAimbotTargetPart(player.Character)
            if not tp then continue end
            if Config.Aimbot.VisibleCheck and not IsVisible(tp) then continue end
            local sp, on = cam:WorldToViewportPoint(tp.Position)
            if not on then continue end
            local d = (mousePos - Vector2.new(sp.X, sp.Y)).Magnitude
            if d < closestDist then
                closestDist = d
                closestPart = tp
                closestPlayer = player
            end
        end
        if closestPlayer then AimbotLockedPlayer = closestPlayer end
        return closestPart

    else
        local vpSize = cam.ViewportSize
        local center = Vector2.new(vpSize.X / 2, vpSize.Y / 2)
        local closestPart, closestDist = nil, Config.Aimbot.FOVRadius
        for _, player in ipairs(Players:GetPlayers()) do
            if not IsPlayerValid(player) then continue end
            local tp = GetAimbotTargetPart(player.Character)
            if not tp then continue end
            if Config.Aimbot.VisibleCheck and not IsVisible(tp) then continue end
            local sp, on = cam:WorldToViewportPoint(tp.Position)
            if not on then continue end
            local d = (center - Vector2.new(sp.X, sp.Y)).Magnitude
            if d < closestDist then
                closestDist = d
                closestPart = tp
            end
        end
        return closestPart
    end
end

-- ============================================
-- AIMBOT LOOP (same mousemoverel as working version)
-- ONLY CHANGE: GuiInset offset for precision
-- ============================================
RunService.RenderStepped:Connect(function()
    Camera = Workspace.CurrentCamera

    if not Config.Aimbot.Enabled or not Config.Aimbot.Active then
        if not Config.Aimbot.Active then AimbotLockedPlayer = nil end
        return
    end

    local cam = Workspace.CurrentCamera
    if not cam then return end

    local tp = GetAimbotTarget()
    if not tp then return end

    local targetPos = tp.Position
    if Config.Aimbot.Prediction and Config.Aimbot.Prediction > 0 then
        pcall(function()
            local vel = tp.AssemblyLinearVelocity
            if vel and vel.Magnitude > 0.1 then
                targetPos = targetPos + vel * Config.Aimbot.Prediction
            end
        end)
    end

    local screenPos, onScreen = cam:WorldToViewportPoint(targetPos)
    if not onScreen then return end

    local mousePos = UserInputService:GetMouseLocation()

    -- PRECISION FIX:
    -- GetMouseLocation() includes GuiInset (adds ~36px Y)
    -- WorldToViewportPoint() does NOT include GuiInset
    -- So we add GuiInset.Y to screenPos to match mouse space
    local deltaX = screenPos.X - mousePos.X
    local deltaY = (screenPos.Y + GuiInset.Y) - mousePos.Y

    local dist = math.sqrt(deltaX * deltaX + deltaY * deltaY)

    if dist < 1 then return end

    local smoothness = math.max(Config.Aimbot.Smoothness or 5, 1)
    local speed = 1 / smoothness

    local moveX = deltaX * speed
    local moveY = deltaY * speed

    -- Snap when very close to avoid jitter
    if dist < 3 then
        moveX = deltaX
        moveY = deltaY
    end

    moveX = math.clamp(moveX, -200, 200)
    moveY = math.clamp(moveY, -200, 200)

    if math.abs(moveX) > 0.3 or math.abs(moveY) > 0.3 then
        mousemoverel(moveX, moveY)
    end
end)

-- ============================================
-- CLEANUP
-- ============================================
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    Camera = Workspace.CurrentCamera
    AimbotLockedPlayer = nil
    pcall(function() GuiInset = GuiService:GetGuiInset() end)
end)

Players.PlayerRemoving:Connect(function(player)
    if AimbotLockedPlayer == player then AimbotLockedPlayer = nil end
end)

-- ============================================
-- SIGNAL
-- Tell main script BSX handles aimbot
-- Do NOT set AX_PF_HandlesESP so main script ESP works
-- ============================================
getgenv().AX_BSXLoaded = true
getgenv().AX_BSX_HandlesAimbot = true

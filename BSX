--[[
    ANNOMALY X - Blox Strike Module (BSX) v17.4
    
    CONFIRMED BY DEBUG:
    - Team = nil for everyone (no teams exist)
    - Camera children are WEAPONS not players
    - Players use standard player.Character
    - TeamCheck is impossible (no team system)
    
    Creator: ElSacaLeche
]]

if not getgenv().AX_Config then
    repeat task.wait() until getgenv().AX_Config
end

local Config = getgenv().AX_Config

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = workspace
local LocalPlayer = Players.LocalPlayer

local mousemoverel = mousemoverel or (Input and Input.MouseMove) or function() end

-- ============================================
-- FORCE DISABLE TEAM CHECK
-- BSX has NO teams (Team = nil, 0 teams exist)
-- ============================================
Config.Aimbot.TeamCheck = false
Config.ESP.TeamCheck = false

-- ============================================
-- VARIABLES
-- ============================================
local LockedPlayer = nil
local RandomPart = "Head"
local LastRandomSwitch = 0
local BSXESPObjects = {}
local LastESPUpdate = 0

-- ============================================
-- GET VALID ENEMIES
-- Standard player.Character - confirmed by debug
-- Camera children are weapons, NOT players
-- ============================================
local function GetEnemies()
    local enemies = {}
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        
        local char = player.Character
        if not char then continue end
        
        local humanoid = char:FindFirstChildOfClass("Humanoid")
        if not humanoid or humanoid.Health <= 0 then continue end
        
        local head = char:FindFirstChild("Head")
        local hrp = char:FindFirstChild("HumanoidRootPart")
            or char:FindFirstChild("Torso")
            or char:FindFirstChild("UpperTorso")
        
        if not head and not hrp then continue end
        
        table.insert(enemies, {
            Player = player,
            Character = char,
            Head = head,
            Root = hrp or head,
            Humanoid = humanoid
        })
    end
    
    return enemies
end

-- ============================================
-- GET AIM PART
-- ============================================
local function GetAimPart(char)
    if not char then return nil end
    local s = Config.Aimbot.TargetPart
    
    if s == "Random" then
        local t = tick()
        if t - LastRandomSwitch > (Config.Aimbot.RandomInterval or 0.5) then
            local o = {}
            for _, n in ipairs({"Head", "HumanoidRootPart", "Torso", "UpperTorso"}) do
                local p = char:FindFirstChild(n)
                if p and p:IsA("BasePart") then table.insert(o, n) end
            end
            if #o > 0 then RandomPart = o[math.random(#o)] end
            LastRandomSwitch = t
        end
        local p = char:FindFirstChild(RandomPart)
        if p and p:IsA("BasePart") then return p end
    end
    
    if s == "Head" then
        return char:FindFirstChild("Head")
    end
    
    local p = char:FindFirstChild(s)
    if p and p:IsA("BasePart") then return p end
    
    return char:FindFirstChild("Head")
        or char:FindFirstChild("HumanoidRootPart")
end

-- ============================================
-- VISIBILITY CHECK
-- ============================================
local function CanSee(part, targetChar)
    if not part then return false end
    local myChar = LocalPlayer.Character
    if not myChar then return true end
    local cam = Workspace.CurrentCamera
    if not cam then return true end
    
    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Exclude
    params.FilterDescendantsInstances = {myChar, cam}
    
    local origin = cam.CFrame.Position
    local dir = part.Position - origin
    local dist = dir.Magnitude
    if dist < 3 then return true end
    
    local result = Workspace:Raycast(origin, dir.Unit * (dist - 0.5), params)
    if not result then return true end
    if result.Instance and result.Instance:IsDescendantOf(targetChar) then return true end
    
    return false
end

-- ============================================
-- FIND AIMBOT TARGET
-- No team check - BSX has no teams
-- ============================================
local function FindAimTarget()
    local cam = Workspace.CurrentCamera
    if not cam then return nil end
    
    local mousePos = UserInputService:GetMouseLocation()
    local vp = cam.ViewportSize
    local center = Vector2.new(vp.X / 2, vp.Y / 2)
    local ref = Config.Aimbot.Method == "Aimbot" and center or mousePos
    local fov = Config.Aimbot.FOVRadius or 150
    
    -- Aimlock: keep locked
    if Config.Aimbot.Method == "Aimlock" and LockedPlayer then
        local char = LockedPlayer.Character
        if char then
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum and hum.Health > 0 then
                local aimPart = GetAimPart(char)
                if aimPart then
                    if not Config.Aimbot.VisibleCheck or CanSee(aimPart, char) then
                        local sp, on = cam:WorldToViewportPoint(aimPart.Position)
                        if on then return aimPart end
                    end
                end
            end
        end
        LockedPlayer = nil
    end
    
    local enemies = GetEnemies()
    local bestPart, bestDist, bestPlayer = nil, fov, nil
    
    for _, data in ipairs(enemies) do
        local aimPart = GetAimPart(data.Character)
        if not aimPart then continue end
        
        if Config.Aimbot.VisibleCheck and not CanSee(aimPart, data.Character) then
            continue
        end
        
        local sp, on = cam:WorldToViewportPoint(aimPart.Position)
        if not on then continue end
        
        local d = (ref - Vector2.new(sp.X, sp.Y)).Magnitude
        if d < bestDist then
            bestPart = aimPart
            bestDist = d
            bestPlayer = data.Player
        end
    end
    
    if Config.Aimbot.Method == "Aimlock" and bestPlayer then
        LockedPlayer = bestPlayer
    end
    
    return bestPart
end

-- ============================================
-- ESP CREATE / REMOVE / HIDE
-- Keyed by Player object (stable reference)
-- ============================================
local function CreateESP(player)
    if BSXESPObjects[player] then return end
    
    local e = {}
    e.Box = Drawing.new("Square")
    e.Box.Thickness = 1
    e.Box.Filled = false
    e.Box.Color = Color3.fromRGB(255, 50, 50)
    e.Box.Visible = false
    
    e.Outline = Drawing.new("Square")
    e.Outline.Thickness = 3
    e.Outline.Filled = false
    e.Outline.Color = Color3.fromRGB(0, 0, 0)
    e.Outline.Transparency = 0.5
    e.Outline.Visible = false
    
    e.Name = Drawing.new("Text")
    e.Name.Size = 13
    e.Name.Center = true
    e.Name.Outline = true
    e.Name.Color = Color3.fromRGB(255, 255, 255)
    e.Name.Visible = false
    
    e.Dist = Drawing.new("Text")
    e.Dist.Size = 13
    e.Dist.Center = true
    e.Dist.Outline = true
    e.Dist.Color = Color3.fromRGB(200, 200, 200)
    e.Dist.Visible = false
    
    BSXESPObjects[player] = e
end

local function RemoveESP(player)
    local e = BSXESPObjects[player]
    if not e then return end
    for _, d in pairs(e) do pcall(function() d:Remove() end) end
    BSXESPObjects[player] = nil
end

local function HideESP(player)
    local e = BSXESPObjects[player]
    if not e then return end
    for _, d in pairs(e) do pcall(function() d.Visible = false end) end
end

-- ============================================
-- ESP UPDATE
-- ============================================
local function UpdateBSXESP()
    if not Config.ESP.Enabled or not Config.ESP.Active then
        for p in pairs(BSXESPObjects) do HideESP(p) end
        return
    end
    
    local now = tick()
    if now - LastESPUpdate < 0.08 then return end
    LastESPUpdate = now
    
    local cam = Workspace.CurrentCamera
    if not cam then return end
    
    local enemies = GetEnemies()
    local activePlayers = {}
    
    for _, data in ipairs(enemies) do
        local player = data.Player
        activePlayers[player] = true
        
        if not BSXESPObjects[player] then
            CreateESP(player)
        end
        
        local esp = BSXESPObjects[player]
        if not esp then continue end
        
        local head = data.Head
        local root = data.Root
        local humanoid = data.Humanoid
        
        if root then
            local rootPos = root.Position
            local sp, on = cam:WorldToViewportPoint(rootPos)
            
            if on and sp.Z > 0 then
                -- Box sizing using head and feet positions
                local headScreenPos = sp
                local footScreenPos = sp
                
                if head then
                    headScreenPos = cam:WorldToViewportPoint(head.Position + Vector3.new(0, 0.5, 0))
                end
                footScreenPos = cam:WorldToViewportPoint(rootPos - Vector3.new(0, 3, 0))
                
                local height = math.abs(headScreenPos.Y - footScreenPos.Y)
                if height < 10 then height = 10 end
                local width = height / 2
                
                local minX = sp.X - width / 2
                local minY = headScreenPos.Y
                local boxWidth = width
                local boxHeight = height
                
                -- Boxes
                if Config.ESP.Boxes then
                    esp.Outline.Size = Vector2.new(boxWidth + 2, boxHeight + 2)
                    esp.Outline.Position = Vector2.new(minX - 1, minY - 1)
                    esp.Outline.Visible = true
                    
                    esp.Box.Size = Vector2.new(boxWidth, boxHeight)
                    esp.Box.Position = Vector2.new(minX, minY)
                    esp.Box.Color = Color3.fromRGB(255, 50, 50)
                    esp.Box.Visible = true
                else
                    esp.Box.Visible = false
                    esp.Outline.Visible = false
                end
                
                -- Name
                if Config.ESP.Names then
                    esp.Name.Text = player.DisplayName or player.Name
                    esp.Name.Position = Vector2.new(minX + boxWidth / 2, minY - 16)
                    esp.Name.Visible = true
                else
                    esp.Name.Visible = false
                end
                
                -- Distance
                if Config.ESP.Distance then
                    local myChar = LocalPlayer.Character
                    local myRoot = myChar and (myChar:FindFirstChild("HumanoidRootPart") or myChar:FindFirstChild("Head"))
                    if myRoot then
                        local dist = (myRoot.Position - rootPos).Magnitude
                        esp.Dist.Text = math.floor(dist) .. "m"
                        esp.Dist.Position = Vector2.new(minX + boxWidth / 2, minY + boxHeight + 2)
                        esp.Dist.Visible = true
                    else
                        esp.Dist.Visible = false
                    end
                else
                    esp.Dist.Visible = false
                end
            else
                HideESP(player)
            end
        else
            HideESP(player)
        end
    end
    
    -- Cleanup players who left or died
    for player in pairs(BSXESPObjects) do
        if not activePlayers[player] then
            HideESP(player)
        end
    end
end

-- ============================================
-- MAIN LOOP
-- ============================================
RunService.RenderStepped:Connect(function()
    -- Force no team check every frame
    Config.Aimbot.TeamCheck = false
    Config.ESP.TeamCheck = false
    
    -- AIMBOT
    if Config.Aimbot.Enabled and Config.Aimbot.Active then
        local target = FindAimTarget()
        
        if target then
            local cam = Workspace.CurrentCamera
            if cam then
                local pos = target.Position
                pcall(function()
                    if Config.Aimbot.Prediction and Config.Aimbot.Prediction > 0 then
                        local v = target.AssemblyLinearVelocity
                        if v and v.Magnitude > 0.1 then
                            pos = pos + v * Config.Aimbot.Prediction
                        end
                    end
                end)
                
                local targetPos, on = cam:WorldToViewportPoint(pos)
                if on then
                    local mousePos = UserInputService:GetMouseLocation()
                    local smoothing = 1 / math.max(Config.Aimbot.Smoothness or 5, 1)
                    
                    local deltaX = (targetPos.X - mousePos.X) * smoothing
                    local deltaY = (targetPos.Y - mousePos.Y) * smoothing
                    
                    deltaX = math.clamp(deltaX, -150, 150)
                    deltaY = math.clamp(deltaY, -150, 150)
                    
                    if math.abs(deltaX) > 0.1 or math.abs(deltaY) > 0.1 then
                        mousemoverel(deltaX, deltaY)
                    end
                end
            end
        end
    else
        if not Config.Aimbot.Active then LockedPlayer = nil end
    end
    
    -- ESP
    UpdateBSXESP()
end)

-- ============================================
-- INIT ESP for existing players
-- ============================================
for _, p in ipairs(Players:GetPlayers()) do
    if p ~= LocalPlayer then
        CreateESP(p)
    end
end

Players.PlayerAdded:Connect(function(p)
    CreateESP(p)
end)

-- ============================================
-- CLEANUP
-- ============================================
Players.PlayerRemoving:Connect(function(p)
    if LockedPlayer == p then LockedPlayer = nil end
    RemoveESP(p)
end)

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    LockedPlayer = nil
end)

-- ============================================
-- SIGNAL
-- ============================================
getgenv().AX_BSXLoaded = true
getgenv().AX_BSX_HandlesAimbot = true
getgenv().AX_PF_HandlesESP = true

--[[
    ANNOMALY X - HyperShot Module v3.1
    Silent Aim copiado del script que SÍ funciona
    ESP usando Workspace.Mobs
]]

if not getgenv().AX_Config then
    local t = tick()
    repeat task.wait() until getgenv().AX_Config or tick() - t > 30
end
local Config = getgenv().AX_Config

local mousemoverel = mousemoverel or function() end

local Players           = game:GetService("Players")
local RunService        = game:GetService("RunService")
local Workspace         = game:GetService("Workspace")
local UserInputService  = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Camera            = Workspace.CurrentCamera
local LocalPlayer       = Players.LocalPlayer

-- ================== CARGAR MÓDULOS DEL JUEGO (igual que el script que funciona) ==================
local globalStuff  = require(ReplicatedStorage.Modules.GlobalStuff)
local gameUIMod    = require(LocalPlayer.PlayerGui.GameUI.GameUIMod)
local gunModule    = require(LocalPlayer.PlayerGui.ControllerGUI.NewMainLocal.Tools.Tool.Gun)

-- ================== VISIBILITY ==================
local _visParams = RaycastParams.new()
_visParams.FilterType = Enum.RaycastFilterType.Exclude
_visParams.IgnoreWater = true

local function UpdateVisFilter()
    local t = {Camera}
    local myChar = Workspace:FindFirstChild(LocalPlayer.Name)
    if myChar then table.insert(t, myChar) end
    _visParams.FilterDescendantsInstances = t
end
UpdateVisFilter()

local function IsVisible(part)
    if not part then return false end
    local origin = Camera.CFrame.Position
    local dir = part.Position - origin
    local dist = dir.Magnitude
    if dist < 3 then return true end
    local result = Workspace:Raycast(origin, dir.Unit * (dist - 0.3), _visParams)
    if not result then return true end
    return result.Instance and result.Instance:IsDescendantOf(part.Parent)
end

-- ================== GET CLOSEST TARGET (copiado del script que funciona) ==================
local function getClosestTarget()
    local closestTarget, shortestDist = nil, Config.FOV.Enabled and Config.FOV.Radius or 9e9
    local mousePos = UserInputService:GetMouseLocation()
    local mobs = Workspace:FindFirstChild("Mobs")
    if not mobs then return nil end
    for _, mob in ipairs(mobs:GetChildren()) do
        if globalStuff:SameTeam(LocalPlayer, mob) then continue end
        local humanoid = mob:FindFirstChildOfClass("Humanoid")
        if not humanoid or humanoid.Health <= 0 then continue end
        local part = mob:FindFirstChild("Head") or mob:FindFirstChild("HumanoidRootPart")
        if not part then continue end
        if Config.Silent.VisibleCheck and not IsVisible(part) then continue end
        local screenPos, onScreen = Camera:WorldToScreenPoint(part.Position)
        if not onScreen then continue end
        local dist = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
        if dist < shortestDist then
            shortestDist = dist
            closestTarget = mob
        end
    end
    return closestTarget
end

-- ================== SILENT AIM HOOKS (copiado del script que funciona) ==================
local originalGetMousePos = gameUIMod.GetMousePos
gameUIMod.GetMousePos = function(self, ...)
    if Config.Silent.Enabled and Config.Silent.Active then
        local target = getClosestTarget()
        if target then
            if math.random(100) <= Config.Silent.HitChance then
                local head = target:FindFirstChild("Head")
                if head then
                    return head.Position
                end
            end
        end
    end
    return originalGetMousePos(self, ...)
end

local originalConeOfFire = gunModule.ConeOfFire
gunModule.ConeOfFire = function(self, origin, mousePos, spread)
    if Config.Silent.Enabled and Config.Silent.Active then
        local target = getClosestTarget()
        if target then
            if math.random(100) <= Config.Silent.HitChance then
                local head = target:FindFirstChild("Head")
                if head then
                    return head.Position
                end
            end
        end
    end
    return originalConeOfFire(self, origin, mousePos, spread)
end

local originalGetTotalSpread = gunModule.GetTotalSpread
gunModule.GetTotalSpread = function(self)
    if Config.Silent.Enabled and Config.Silent.Active then
        if getClosestTarget() then
            return 0
        end
    end
    return originalGetTotalSpread(self)
end

warn("[AX HSX] ✅ Silent Aim hooks installed")

-- ================== AIMBOT ==================
local hsAimbotLocked = nil

local function GetAimbotTarget()
    Camera = Workspace.CurrentCamera
    if not Camera then return nil end
    local mobs = Workspace:FindFirstChild("Mobs")
    if not mobs then return nil end

    local vp = Camera.ViewportSize
    local center = Vector2.new(vp.X / 2, vp.Y / 2)
    local mousePos = UserInputService:GetMouseLocation()
    local ref = Config.Aimbot.Method == "Aimbot" and center or mousePos
    local best, bestDist = nil, Config.Aimbot.FOVRadius or 150

    if Config.Aimbot.Method == "Aimlock" and hsAimbotLocked and hsAimbotLocked.Parent then
        local hum = hsAimbotLocked:FindFirstChildOfClass("Humanoid")
        if hum and hum.Health > 0 then
            local p = hsAimbotLocked:FindFirstChild("Head") or hsAimbotLocked:FindFirstChild("HumanoidRootPart")
            if p and (not Config.Aimbot.VisibleCheck or IsVisible(p)) then
                local sp, on = Camera:WorldToViewportPoint(p.Position)
                if on then return p end
            end
        end
        hsAimbotLocked = nil
    end

    for _, mob in ipairs(mobs:GetChildren()) do
        if Config.Aimbot.TeamCheck and globalStuff:SameTeam(LocalPlayer, mob) then continue end
        local hum = mob:FindFirstChildOfClass("Humanoid")
        if not hum or hum.Health <= 0 then continue end
        local p = mob:FindFirstChild("Head") or mob:FindFirstChild("HumanoidRootPart")
        if not p then continue end
        if Config.Aimbot.VisibleCheck and not IsVisible(p) then continue end
        local sp, on = Camera:WorldToViewportPoint(p.Position)
        if not on then continue end
        local d = (Vector2.new(sp.X, sp.Y) - ref).Magnitude
        if d < bestDist then bestDist = d; best = p; if Config.Aimbot.Method == "Aimlock" then hsAimbotLocked = mob end end
    end
    return best
end

-- ================== ESP ==================
local HyperShotESP = {}
local HSLastESP = 0

local function CreateHSESP(key)
    if HyperShotESP[key] then return end
    local e = {}
    e.Box = Drawing.new("Square"); e.Box.Thickness=1; e.Box.Filled=false; e.Box.Color=Color3.fromRGB(255,255,255); e.Box.Visible=false
    e.Outline = Drawing.new("Square"); e.Outline.Thickness=3; e.Outline.Filled=false; e.Outline.Color=Color3.fromRGB(0,0,0); e.Outline.Transparency=0.5; e.Outline.Visible=false
    e.Name = Drawing.new("Text"); e.Name.Size=13; e.Name.Center=true; e.Name.Outline=true; e.Name.Color=Color3.fromRGB(255,255,255); e.Name.Visible=false
    e.Distance = Drawing.new("Text"); e.Distance.Size=12; e.Distance.Center=true; e.Distance.Outline=true; e.Distance.Color=Color3.fromRGB(200,200,200); e.Distance.Visible=false
    e.HealthBG = Drawing.new("Square"); e.HealthBG.Thickness=1; e.HealthBG.Filled=true; e.HealthBG.Color=Color3.fromRGB(0,0,0); e.HealthBG.Transparency=0.5; e.HealthBG.Visible=false
    e.HealthBar = Drawing.new("Square"); e.HealthBar.Thickness=1; e.HealthBar.Filled=true; e.HealthBar.Color=Color3.fromRGB(0,255,0); e.HealthBar.Visible=false
    HyperShotESP[key] = e
end

local function RemoveHSESP(key)
    local e = HyperShotESP[key]
    if not e then return end
    for _, d in pairs(e) do pcall(function() d:Remove() end) end
    HyperShotESP[key] = nil
end

local function HideHSESP(key)
    local e = HyperShotESP[key]
    if not e then return end
    for _, d in pairs(e) do pcall(function() d.Visible = false end) end
end

local function UpdateHyperShotESP()
    if not Config.ESP.Enabled or not Config.ESP.Active then
        for key in pairs(HyperShotESP) do HideHSESP(key) end
        return
    end
    local now = tick()
    if now - HSLastESP < 0.08 then return end
    HSLastESP = now
    Camera = Workspace.CurrentCamera
    if not Camera then return end

    local mobs = Workspace:FindFirstChild("Mobs")
    if not mobs then
        for key in pairs(HyperShotESP) do HideHSESP(key) end
        return
    end

    local activeKeys = {}
    for _, mob in ipairs(mobs:GetChildren()) do
        if not mob:IsA("Model") then continue end
        local key = mob.Name
        activeKeys[key] = true

        if Config.ESP.TeamCheck and globalStuff:SameTeam(LocalPlayer, mob) then
            HideHSESP(key); continue
        end

        local hum = mob:FindFirstChildOfClass("Humanoid")
        local rp = mob:FindFirstChild("HumanoidRootPart") or mob:FindFirstChild("FakeHRP") or mob:FindFirstChild("UpperTorso")
        local head = mob:FindFirstChild("Head")
        if not hum or not rp or hum.Health <= 0 then HideHSESP(key); continue end

        local dist = (Camera.CFrame.Position - rp.Position).Magnitude
        if dist > Config.ESP.MaxDistance then HideHSESP(key); continue end

        local sp, on = Camera:WorldToViewportPoint(rp.Position)
        if not on then HideHSESP(key); continue end

        if not HyperShotESP[key] then CreateHSESP(key) end
        local esp = HyperShotESP[key]
        if not esp then continue end

        local hSP = head and select(1, Camera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.5, 0))) or sp
        local fSP = select(1, Camera:WorldToViewportPoint(rp.Position - Vector3.new(0, 3, 0)))
        local height = math.max(math.abs(hSP.Y - fSP.Y), 10)
        local width = height / 2
        local minX = sp.X - width / 2
        local minY = hSP.Y

        local isBot = mob.Name:find("__Bot") ~= nil
        local col
        if isBot then
            col = head and IsVisible(head) and Color3.fromRGB(255, 200, 50) or Color3.fromRGB(255, 120, 30)
        elseif head and IsVisible(head) then
            col = Color3.fromRGB(50, 255, 50)
        else
            col = Color3.fromRGB(255, 50, 50)
        end

        if Config.ESP.Boxes then
            esp.Outline.Size=Vector2.new(width+2,height+2); esp.Outline.Position=Vector2.new(minX-1,minY-1); esp.Outline.Visible=true
            esp.Box.Size=Vector2.new(width,height); esp.Box.Position=Vector2.new(minX,minY); esp.Box.Color=col; esp.Box.Visible=true
        else esp.Box.Visible=false; esp.Outline.Visible=false end

        if Config.ESP.Names then
            local dn = mob.Name
            if isBot then dn = dn:gsub("__Bot","").." [BOT]" end
            esp.Name.Text=dn; esp.Name.Position=Vector2.new(minX+width/2,minY-16); esp.Name.Color=col; esp.Name.Visible=true
        else esp.Name.Visible=false end

        if Config.ESP.Distance then
            esp.Distance.Text=math.floor(dist).."m"; esp.Distance.Position=Vector2.new(minX+width/2,minY+height+2); esp.Distance.Visible=true
        else esp.Distance.Visible=false end

        if Config.ESP.Boxes and hum then
            local pct=math.clamp(hum.Health/math.max(hum.MaxHealth,1),0,1)
            local bh=height*pct
            local hc=pct>0.5 and Color3.fromRGB(math.floor(255*(1-pct)*2),255,0) or Color3.fromRGB(255,math.floor(255*pct*2),0)
            esp.HealthBG.Size=Vector2.new(3,height); esp.HealthBG.Position=Vector2.new(minX-6,minY); esp.HealthBG.Visible=true
            esp.HealthBar.Size=Vector2.new(3,bh); esp.HealthBar.Position=Vector2.new(minX-6,minY+(height-bh)); esp.HealthBar.Color=hc; esp.HealthBar.Visible=true
        else esp.HealthBG.Visible=false; esp.HealthBar.Visible=false end
    end

    for key in pairs(HyperShotESP) do
        if not activeKeys[key] then RemoveHSESP(key) end
    end
end

-- ================== MAIN LOOPS ==================
task.delay(1, function()
    RunService.RenderStepped:Connect(function()
        Camera = Workspace.CurrentCamera
        -- Aimbot
        if Config.Aimbot.Enabled and Config.Aimbot.Active then
            local tp = GetAimbotTarget()
            if tp then
                local pos = tp.Position
                pcall(function()
                    if Config.Aimbot.Prediction and Config.Aimbot.Prediction > 0 then
                        local v = tp.AssemblyLinearVelocity
                        if v and v.Magnitude > 0.5 then pos = pos + v * Config.Aimbot.Prediction end
                    end
                end)
                local sm = math.max(Config.Aimbot.Smoothness or 5, 1)
                if Config.Aimbot.Method == "Aimbot" then
                    local cur = Camera.CFrame
                    local tgt = CFrame.lookAt(cur.Position, pos)
                    Camera.CFrame = sm <= 1 and tgt or cur:Lerp(tgt, 1/sm)
                else
                    local sp, on = Camera:WorldToViewportPoint(pos)
                    if on then
                        local mp = UserInputService:GetMouseLocation()
                        local dx, dy = sp.X-mp.X, sp.Y-mp.Y
                        local d = math.sqrt(dx*dx+dy*dy)
                        if d > 1 then
                            local spd = math.clamp(1/sm, 0.05, 0.8)
                            local mx = math.clamp(dx*spd, -150, 150)
                            local my = math.clamp(dy*spd, -150, 150)
                            if math.abs(mx) > 0.3 or math.abs(my) > 0.3 then mousemoverel(mx, my) end
                        end
                    end
                end
            else
                if not Config.Aimbot.Active then hsAimbotLocked = nil end
            end
        else
            if not Config.Aimbot.Active then hsAimbotLocked = nil end
        end
    end)
end)

task.delay(2, function()
    RunService.Heartbeat:Connect(function()
        UpdateHyperShotESP()
    end)
end)

-- Vis filter update
task.spawn(function()
    while true do
        task.wait(2)
        UpdateVisFilter()
    end
end)

-- ================== FLAGS ==================
getgenv().AX_HyperShotLoaded        = true
getgenv().AX_HyperShotHandlesAimbot = true
getgenv().AX_HyperShotHandlesESP    = true
getgenv().AX_HyperShotHandlesSilent = true

warn("[AX HSX] ✅ HyperShot v3.1 loaded - Silent+Aimbot+ESP")

--[[
    ╔═══════════════════════════════════════════════════════════╗
    ║           ANNOMALY X - Arsenal Module                     ║
    ║           Mouse.__index + Workspace raycast hook          ║
    ║           Creator: ElSacaLeche                            ║
    ╚═══════════════════════════════════════════════════════════╝
    
    ARSENAL ANALYSIS:
    
    Arsenal's weapon system:
    1. Reads Mouse.Hit for aim direction
    2. Uses workspace:FindPartOnRay() for bullet raycasts
    3. Sends hit data via RemoteEvents
    
    Arsenal's anticheat:
    - Checks fire rate (don't shoot faster than allowed)
    - Checks damage values (don't modify damage)
    - Does NOT heavily check aim consistency
    - No BACS-level metamethod detection
    
    METHOD:
    1. Hook Mouse.__index for Hit/Target/UnitRay
    2. Hook game.__namecall for FindPartOnRay (safe in Arsenal)
    3. Both redirect to target enemy
    
    Arsenal PlaceId: 286090429
]]

if not getgenv().AX_Config then
    repeat task.wait() until getgenv().AX_Config
end

local Config = getgenv().AX_Config

local cloneref = cloneref or function(o) return o end
local newcclosure = newcclosure or function(f) return f end
local hookfunction = hookfunction or replaceclosure or detour_function
local hookmetamethod = hookmetamethod
local getnamecallmethod = getnamecallmethod or get_namecall_method
local checkcaller = checkcaller or function() return false end
local getrawmetatable = getrawmetatable
local setreadonly = setreadonly or function() end

local Players = cloneref(game:GetService("Players"))
local RunService = cloneref(game:GetService("RunService"))
local Workspace = cloneref(game:GetService("Workspace"))
local UserInputService = cloneref(game:GetService("UserInputService"))
local Camera = Workspace.CurrentCamera

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

-- ============================================
-- ARSENAL AC HANDLING
-- Arsenal's AC is lighter than CA/Rivals
-- Safe to use hookmetamethod here
-- ============================================

-- Kick protection
pcall(function()
    local oldKick = LocalPlayer.Kick
    if typeof(oldKick) == "function" then
        hookfunction(oldKick, newcclosure(function(self, ...)
            if self == LocalPlayer then return end
            return oldKick(self, ...)
        end))
    end
end)

-- Error suppression
pcall(function()
    local SC = cloneref(game:GetService("ScriptContext"))
    if getconnections then
        for _, conn in ipairs(getconnections(SC.Error)) do
            pcall(function() conn:Disable() end)
        end
    end
end)

-- ============================================
-- TARGET FINDER
-- ============================================

local CurrentTarget = nil

local function IsVisible(targetPart)
    if not targetPart then return false end
    local character = LocalPlayer.Character
    if not character then return true end
    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Blacklist
    params.FilterDescendantsInstances = {character, Camera}
    local origin = Camera.CFrame.Position
    local direction = targetPart.Position - origin
    local result = Workspace:Raycast(origin, direction, params)
    if result then return result.Instance:IsDescendantOf(targetPart.Parent) end
    return true
end

local function GetTargetPart(character, setting)
    if not character then return nil end
    local parts = {"Head", "HumanoidRootPart", "UpperTorso", "Torso", "LowerTorso"}
    if setting == "Random" then
        local valid = {}
        for _, name in ipairs(parts) do
            local p = character:FindFirstChild(name)
            if p then table.insert(valid, p) end
        end
        if #valid > 0 then return valid[math.random(1, #valid)] end
    end
    return character:FindFirstChild(setting)
        or character:FindFirstChild("Head")
        or character:FindFirstChild("HumanoidRootPart")
        or character:FindFirstChild("UpperTorso")
        or character:FindFirstChild("Torso")
end

local function FindTarget()
    Camera = Workspace.CurrentCamera
    if not Camera then return nil end
    
    local closest = nil
    local closestDist = Config.FOV.Enabled and Config.FOV.Radius or math.huge
    local screenCenter = Camera.ViewportSize / 2
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        if Config.Silent.TeamCheck and player.Team and LocalPlayer.Team 
            and player.Team == LocalPlayer.Team then continue end
        
        local character = player.Character
        if not character then continue end
        
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if not humanoid or humanoid.Health <= 0 then continue end
        
        local part = GetTargetPart(character, Config.Silent.TargetPart)
        if not part then continue end
        
        if Config.Silent.VisibleCheck and not IsVisible(part) then continue end
        
        local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)
        if not onScreen then continue end
        
        local dist = (Vector2.new(screenPos.X, screenPos.Y) - screenCenter).Magnitude
        if dist < closestDist then
            closestDist = dist
            closest = part
        end
    end
    
    return closest
end

-- ============================================
-- LAYER 1: MOUSE __INDEX HOOK
-- Redirects Mouse.Hit, Mouse.Target, Mouse.UnitRay
-- ============================================

local mouseHooked = false

pcall(function()
    local mt = getrawmetatable(Mouse)
    if mt then
        local oldIndex = mt.__index
        setreadonly(mt, false)
        
        mt.__index = newcclosure(function(self, key)
            if self == Mouse and CurrentTarget and CurrentTarget.Parent then
                if Config.Silent.Enabled and Config.Silent.Active then
                    if math.random(1, 100) <= Config.Silent.HitChance then
                        if key == "Hit" then
                            return CFrame.new(CurrentTarget.Position)
                        elseif key == "Target" then
                            return CurrentTarget
                        elseif key == "X" then
                            local pos = Camera:WorldToScreenPoint(CurrentTarget.Position)
                            return pos.X
                        elseif key == "Y" then
                            local pos = Camera:WorldToScreenPoint(CurrentTarget.Position)
                            return pos.Y
                        elseif key == "UnitRay" then
                            local origin = Camera.CFrame.Position
                            local dir = (CurrentTarget.Position - origin).Unit
                            return Ray.new(origin, dir)
                        end
                    end
                end
            end
            return oldIndex(self, key)
        end)
        
        setreadonly(mt, true)
        mouseHooked = true
    end
end)

-- ============================================
-- LAYER 2: __NAMECALL HOOK FOR RAYCASTS
-- Arsenal uses FindPartOnRay - safe to hook here
-- Arsenal does NOT have BACS-level detection
-- ============================================

local oldNamecall
oldNamecall = hookmetamethod(game, "__namecall", newcclosure(function(self, ...)
    local method = getnamecallmethod()
    local args = {...}
    
    if checkcaller() then
        return oldNamecall(self, ...)
    end
    
    if not Config.Silent.Enabled or not Config.Silent.Active then
        return oldNamecall(self, ...)
    end
    
    if not CurrentTarget or not CurrentTarget.Parent then
        return oldNamecall(self, ...)
    end
    
    if math.random(1, 100) > Config.Silent.HitChance then
        return oldNamecall(self, ...)
    end
    
    if self == Workspace or self == workspace then
        if method == "Raycast" then
            local origin = args[1]
            local direction = args[2]
            if typeof(origin) == "Vector3" and typeof(direction) == "Vector3" then
                args[2] = (CurrentTarget.Position - origin).Unit * direction.Magnitude
                return oldNamecall(self, unpack(args))
            end
        end
        
        if method == "FindPartOnRay" then
            local ray = args[1]
            if typeof(ray) == "Ray" then
                local newDir = (CurrentTarget.Position - ray.Origin).Unit * ray.Direction.Magnitude
                args[1] = Ray.new(ray.Origin, newDir)
                return oldNamecall(self, unpack(args))
            end
        end
        
        if method == "FindPartOnRayWithIgnoreList" then
            local ray = args[1]
            if typeof(ray) == "Ray" then
                local newDir = (CurrentTarget.Position - ray.Origin).Unit * ray.Direction.Magnitude
                args[1] = Ray.new(ray.Origin, newDir)
                return oldNamecall(self, unpack(args))
            end
        end
        
        if method == "FindPartOnRayWithWhitelist" then
            local ray = args[1]
            if typeof(ray) == "Ray" then
                local newDir = (CurrentTarget.Position - ray.Origin).Unit * ray.Direction.Magnitude
                args[1] = Ray.new(ray.Origin, newDir)
                return oldNamecall(self, unpack(args))
            end
        end
    end
    
    return oldNamecall(self, ...)
end))

-- ============================================
-- TARGET UPDATE
-- ============================================

RunService.Heartbeat:Connect(function()
    Camera = Workspace.CurrentCamera
    if Config.Silent.Enabled and Config.Silent.Active then
        CurrentTarget = FindTarget()
    else
        CurrentTarget = nil
    end
end)

-- ============================================
-- CLEANUP
-- ============================================

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(0.5)
    Camera = Workspace.CurrentCamera
    CurrentTarget = nil
end)

-- ============================================
-- SIGNAL
-- ============================================
getgenv().AX_ArsenalLoaded = true

print("  ✅ ARSENAL MODULE loaded")
print("  ✅ Mouse.__index: " .. tostring(mouseHooked))
print("  ✅ __namecall: Raycast + FindPartOnRay")
print("  ✅ Dual-layer silent aim active")

--[[
    ╔═══════════════════════════════════════════════════════════╗
    ║        ANNOMALY X - Phantom Forces Silent Aim Module      ║
    ║        Method: network.send "newbullets" + trajectory     ║
    ║        + bullethit spoofing for instant registration      ║
    ║        Creator: ElSacaLeche                               ║
    ╚═══════════════════════════════════════════════════════════╝
    
    HOW PF SILENT AIM WORKS (Advanced Method):
    
    1. PF sends bullets via network.send("newbullets", data)
    2. We intercept this call and recalculate bullet trajectory
       to point at the target using PF's own trajectory() function
    3. We then spoof a "bullethit" call so the server registers
       the hit instantly
    4. This is superior to Motor6D because:
       - Motor6D can be detected by checking C0 consistency
       - network.send hook works at the packet level
       - Using PF's own trajectory() function makes it legitimate
       - bullethit spoofing = instant kill registration
    
    ANTI-DETECTION MEASURES:
    - Uses PF's own internal functions (trajectory, getbodyparts)
    - Bullet direction calculated with proper physics (gravity, speed)
    - firepos/camerapos spoofed from actual camera position
    - Heartbeat-based delay option for undetectable timing
    - No metamethod hooks (__index, __newindex, __namecall)
]]

-- Wait for Config
if not getgenv().AX_Config then
    repeat task.wait() until getgenv().AX_Config
end

local Config = getgenv().AX_Config

local newcclosure = newcclosure or function(f) return f end

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Camera = Workspace.CurrentCamera

local LocalPlayer = Players.LocalPlayer

-- ============================================
-- PF INTERNAL REFERENCES (via getgc)
-- ============================================
local network = nil
local trajectory = nil
local gamelogic = nil
local getbodyparts = nil
local cameraModule = nil
local heartbeatDelta = 0

-- Scan garbage collector for PF internals
local function ScanPFInternals()
    local found = {network = false, trajectory = false, gamelogic = false, getbodyparts = false, camera = false}
    
    for _, v in pairs(getgc(true)) do
        if type(v) == "table" then
            -- getbodyparts function
            if rawget(v, "getbodyparts") and not found.getbodyparts then
                getbodyparts = v.getbodyparts
                found.getbodyparts = true
            end
        end
        
        if type(v) == "function" then
            -- trajectory function
            local ok, name = pcall(function() return debug.getinfo(v).name end)
            if ok and name == "trajectory" and not found.trajectory then
                trajectory = v
                found.trajectory = true
            end
            
            -- Scan upvalues for network, gamelogic, camera
            local upvalueCount = 0
            pcall(function()
                for i2, v2 in pairs(debug.getupvalues(v)) do
                    upvalueCount = upvalueCount + 1
                    if type(v2) == "table" then
                        if rawget(v2, "send") and not found.network then
                            network = v2
                            found.network = true
                        end
                        if rawget(v2, "gammo") and not found.gamelogic then
                            gamelogic = v2
                            found.gamelogic = true
                        end
                        if rawget(v2, "basecframe") and not found.camera then
                            cameraModule = v2
                            found.camera = true
                        end
                    end
                end
            end)
        end
        
        -- Early exit if all found
        if found.network and found.trajectory and found.gamelogic and found.getbodyparts and found.camera then
            break
        end
    end
    
    return found.network and found.trajectory and found.gamelogic and found.getbodyparts
end

-- Attempt to scan
local scanSuccess = ScanPFInternals()

if not scanSuccess then
    warn("[ANNOMALY X] PF Module: Failed to find all internal references")
    warn("[ANNOMALY X] network:", network ~= nil)
    warn("[ANNOMALY X] trajectory:", trajectory ~= nil)
    warn("[ANNOMALY X] gamelogic:", gamelogic ~= nil)
    warn("[ANNOMALY X] getbodyparts:", getbodyparts ~= nil)
    warn("[ANNOMALY X] camera:", cameraModule ~= nil)
    getgenv().AX_PFLoaded = false
    return
end

-- ============================================
-- HEARTBEAT TRACKER (for undetectable timing)
-- ============================================
task.spawn(function()
    while true do
        heartbeatDelta = RunService.Heartbeat:Wait()
    end
end)

-- ============================================
-- PF TARGET PART RESOLVER
-- ============================================
local function ResolvePFTargetPart(targetPartSetting)
    -- Map ANNOMALY X config names to PF body part names
    local partMap = {
        ["Head"] = "Head",
        ["HumanoidRootPart"] = "Torso",
        ["Torso"] = "Torso",
        ["UpperTorso"] = "Torso"
    }
    
    if targetPartSetting == "Random" then
        local options = {"Head", "Torso", "Left Arm", "Right Arm"}
        return options[math.random(1, #options)]
    end
    
    return partMap[targetPartSetting] or "Head"
end

-- ============================================
-- GET CLOSEST TARGET (PF Method)
-- Uses getbodyparts() for proper PF player detection
-- FOV check from screen center
-- ============================================
local function GetClosestPFTarget()
    Camera = Workspace.CurrentCamera
    local closestDist = math.huge
    local closestBody = nil
    local closestPlayer = nil
    
    local fovRadius = Config.FOV.Enabled and Config.FOV.Radius or math.huge
    local screenCenter = Camera.ViewportSize / 2
    
    for _, player in pairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        
        -- Team check
        if Config.Silent.TeamCheck then
            if player.Team and LocalPlayer.Team and player.Team.Name == LocalPlayer.Team.Name then
                continue
            end
        else
            -- PF always has teams, skip same team
            if player.Team and LocalPlayer.Team and player.Team.Name == LocalPlayer.Team.Name then
                continue
            end
        end
        
        -- Get body parts using PF's internal function
        local targetBody = nil
        pcall(function()
            targetBody = getbodyparts(player)
        end)
        
        if not targetBody then continue end
        if not rawget(targetBody, "rootpart") then continue end
        
        local rootParent = targetBody.rootpart.Parent
        if not rootParent then continue end
        
        local headPart = rootParent:FindFirstChild("Head")
        if not headPart then continue end
        
        -- Screen position check
        local screenPos, isOnScreen = Camera:WorldToViewportPoint(headPart.Position)
        if not isOnScreen then continue end
        
        local screenOffset = Vector2.new(screenPos.X, screenPos.Y) - screenCenter
        local screenDist = screenOffset.Magnitude
        
        -- FOV check
        if screenDist > fovRadius then continue end
        
        -- Visibility check
        if Config.Silent.VisibleCheck then
            local castPoints = {targetBody.rootpart.Position}
            local ignoreList = {rootParent, LocalPlayer.Character, Camera}
            local obscuring = Camera:GetPartsObscuringTarget(castPoints, ignoreList)
            if #obscuring > 0 then continue end
        end
        
        if screenDist < closestDist then
            closestDist = screenDist
            closestBody = rootParent
            closestPlayer = player
        end
    end
    
    return closestBody, closestPlayer
end

-- ============================================
-- HOOK network.send FOR SILENT AIM
-- This is the core - intercepts bullet packets
-- ============================================
local originalSend = network.send

network.send = function(self, ...)
    local args = {...}
    
    -- Intercept "newbullets" event
    if args[1] == "newbullets" then
        -- Check if silent aim is active
        if Config.Silent.Enabled and Config.Silent.Active then
            -- Hit chance check
            if math.random(1, 100) <= Config.Silent.HitChance then
                local targetBody, targetPlayer = GetClosestPFTarget()
                
                if targetBody and targetPlayer then
                    -- Resolve which part to hit
                    local hitPartName = ResolvePFTargetPart(Config.Silent.TargetPart)
                    local hitPart = targetBody:FindFirstChild(hitPartName)
                    
                    if not hitPart then
                        hitPart = targetBody:FindFirstChild("Head") or targetBody:FindFirstChild("Torso")
                    end
                    
                    if hitPart and cameraModule and gamelogic and gamelogic.currentgun then
                        local playerPosition = cameraModule.basecframe.Position
                        
                        -- Spoof fire position and camera position
                        args[2]["firepos"] = playerPosition
                        args[2]["camerapos"] = playerPosition
                        
                        -- Recalculate bullet trajectory using PF's own function
                        local bulletSpeed = gamelogic.currentgun.data.bulletspeed
                        
                        for i, bullet in pairs(args[2]["bullets"]) do
                            bullet[1] = trajectory(
                                playerPosition,
                                Vector3.new(0, Workspace.Gravity, 0),
                                hitPart.Position,
                                bulletSpeed
                            )
                        end
                        
                        -- Send the modified bullet packet
                        originalSend(self, unpack(args))
                        
                        -- Wait for bullet travel time (anti-detection)
                        local distance = (hitPart.Position - playerPosition).Magnitude
                        local travelTime = distance / bulletSpeed
                        
                        local totalWaited = 0
                        repeat
                            totalWaited = totalWaited + heartbeatDelta
                            RunService.Heartbeat:Wait()
                        until totalWaited >= travelTime
                        
                        -- Send bullethit for instant registration
                        for i, bullet in pairs(args[2]["bullets"]) do
                            if bullet[2] then
                                local bullethitArgs = {
                                    "bullethit",
                                    targetPlayer,
                                    hitPart.Position,
                                    hitPart,
                                    bullet[2]
                                }
                                originalSend(self, unpack(bullethitArgs))
                            end
                        end
                        
                        return -- Don't call original again
                    end
                end
            end
        end
    end
    
    -- Pass through all other network calls
    return originalSend(self, unpack(args))
end

-- ============================================
-- CLEANUP ON CHARACTER RESPAWN
-- ============================================
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    Camera = Workspace.CurrentCamera
end)

-- ============================================
-- SIGNAL: Module loaded
-- ============================================
getgenv().AX_PFLoaded = true

print("  ✅ PF MODULE - network.send hooked (newbullets + bullethit)")
print("  ✅ PF MODULE - trajectory() + getbodyparts() acquired")
print("  ✅ PF MODULE - Bullet travel time delay active")

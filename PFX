-- Phantom Forces Silent Aim Module v2026 (Replication + Trajectory Redirect)
-- Load this after your main config & services
-- Assumes getgenv().AX_Config exists with .Silent subtable

if not getgenv().AX_Config or not getgenv().AX_Config.Silent.Enabled then return end

local Players        = game:GetService("Players")
local RunService     = game:GetService("RunService")
local Workspace      = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Camera         = Workspace.CurrentCamera
local LocalPlayer    = Players.LocalPlayer

-- Config shortcuts (adapt from your AX_Config)
local Silent         = getgenv().AX_Config.Silent
local FOV            = getgenv().AX_Config.FOV or {Enabled = false, Radius = 150}
local Prediction     = getgenv().AX_Config.Aimbot.Prediction or 0.135  -- PF bullet drop time factor

-- Cache require modules (PF-specific)
local ReplicationInterface = nil
local PublicSettings       = nil
local BulletObject         = nil
local NetworkClient        = nil

for _, v in ipairs(getgc(true)) do
    if type(v) == "table" then
        if rawget(v, "operateOnAllEntries") then ReplicationInterface = v end
        if rawget(v, "bulletAcceleration") then PublicSettings = v end
    elseif type(v) == "function" and debug.getinfo(v).name == "require" then
        local success, mod = pcall(v, game.ReplicatedStorage.Modules)
        if success then
            if mod and mod.BulletObject then BulletObject = mod.BulletObject end
            if mod and mod.Network then NetworkClient = mod.Network end
        end
    end
end

if not (ReplicationInterface and PublicSettings and BulletObject and NetworkClient) then
    warn("[Silent PF] Failed to cache PF modules — falling back or error.")
    return
end

-- Silent target cache
local CurrentSilentTarget = nil

local function GetClosestSilent()
    local mousePos = UserInputService:GetMouseLocation()
    local center   = Camera.ViewportSize / 2
    local best, dist = nil, FOV.Enabled and FOV.Radius or math.huge

    ReplicationInterface.operateOnAllEntries(function(player, entry)
        if player == LocalPlayer or (Silent.TeamCheck and player.Team == LocalPlayer.Team) then return end
        local charModel = entry._thirdPersonObject and entry._thirdPersonObject._characterHash
        if not charModel then return end

        local part = charModel[Silent.TargetPart or "Head"]
        if not part or not part.Parent then return end

        local hum = charModel:FindFirstChildOfClass("Humanoid")
        if not hum or hum.Health <= 0 then return end

        local screen, onScreen = Camera:WorldToViewportPoint(part.Position)
        if not onScreen then return end

        local mag = (Vector2.new(screen.X, screen.Y) - mousePos).Magnitude
        if mag < dist then
            dist = mag
            best = {Player = player, Part = part, Pos = part.Position, Entry = entry}
        end
    end)

    return best
end

-- Throttle update
RunService.Heartbeat:Connect(function()
    if not Silent.Active then CurrentSilentTarget = nil return end
    CurrentSilentTarget = GetClosestSilent()
end)

-- Hook network send for newbullets
local oldSend = NetworkClient.send
NetworkClient.send = function(self, name, ...)
    if name == "newbullets" and CurrentSilentTarget and math.random() <= (Silent.HitChance or 1) then
        local args = {...}
        local data = args[2]  -- usually {firepos, bullets, etc.}
        if data and data.bullets then
            local targetPos = CurrentSilentTarget.Pos
            if Prediction > 0 then
                local vel = CurrentSilentTarget.Entry._velspring.t or Vector3.zero
                targetPos += vel * Prediction
            end

            local velocity = PublicSettings.trajectory(
                data.firepos,
                PublicSettings.bulletAcceleration,
                targetPos,
                data.bullets[1][1].Magnitude,
                CurrentSilentTarget.Entry._velspring.t
            )

            for i = 1, #data.bullets do
                data.bullets[i][1] = velocity + Vector3.new(
                    (math.random()-0.5)*0.4,  -- small offset randomization
                    (math.random()-0.5)*0.4,
                    (math.random()-0.5)*0.4
                )
            end
        end
    end
    return oldSend(self, name, ...)
end

-- Optional BulletObject hook for client prediction (helps visual consistency)
local oldNewBullet = BulletObject.new
BulletObject.new = function(data)
    if Silent.Active and CurrentSilentTarget then
        -- similar redirect logic if needed for local sim
    end
    return oldNewBullet(data)
end

print("[Nyx PF Silent] Loaded — replication trajectory redirect active.")
